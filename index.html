<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Help.Drugix — комбо-поиск</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0f1115; --card:#151924; --ink:#e6e8ef; --muted:#9aa3b2; --accent:#6aa0ff; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:960px;margin:0 auto;padding:20px}
    .brand{display:flex;align-items:center;gap:12px;margin:6px 0 18px}
    h1{font-size:20px;margin:0}
    .tabs{display:flex;gap:10px;margin-bottom:14px}
    .tab{padding:10px 16px;border-radius:10px;cursor:pointer;background:#0d1320;border:1px solid #273047}
    .tab.active{background:var(--accent);color:#0b1020;font-weight:700}
    .card{background:var(--card);border:1px solid #273047;border-radius:16px;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input,select,button{background:#0e121a;color:var(--ink);border:1px solid #2a3346;border-radius:12px;padding:12px 14px;font-size:15px}
    input::placeholder{color:#71809a}
    button{background:var(--accent);border-color:var(--accent);color:#0b1020;font-weight:700;cursor:pointer}
    .pill{background:#0d1320;border:1px solid #2a3346;border-radius:999px;padding:6px 10px;font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;margin-top:12px}
    .drug{
      position:relative;
      background:#0e121a;border:1px solid #2a3346;border-radius:14px;padding:12px;
      padding-right:44px; /* запас для звезды */
    }
    .fav{
      position:absolute;top:10px;right:10px;background:none;border:none;font-size:22px;
      cursor:pointer;color:#556580;transition:0.15s ease-in-out;
    }
    .fav:hover{transform:scale(1.2)}
    .fav.active{color:#ffd93d;text-shadow:0 0 6px rgba(255,217,61,.7);transform:scale(1.25)}
    .name{font-weight:700;margin-bottom:4px}
    .meta{color:var(--muted);font-size:13px;margin:6px 0}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .empty{color:#9aa3b2;opacity:.8;padding:24px;text-align:center}
    a{color:#9bbcff;text-decoration:none}

    /* Автоподсказки */
    .searchbox{position:relative;flex:1;min-width:220px}
    .ac{
      position:absolute;left:0;right:0;top:100%;margin-top:6px;
      background:#0e121a;border:1px solid #2a3346;border-radius:12px;
      box-shadow:0 4px 18px rgba(0,0,0,.35);z-index:20;max-height:260px;overflow:auto;
      display:none;
    }
    .ac-item{padding:10px 12px;cursor:pointer;border-bottom:1px solid #1b2436}
    .ac-item:last-child{border-bottom:none}
    .ac-item b{color:#e9ecf6}
    .ac-item:hover,.ac-item.active{background:#162032}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand"><h1>Help.Drugix — поиск комбинированных препаратов (РФ)</h1></div>

    <div class="tabs">
      <div class="tab active" id="tabSearch">Поиск</div>
      <div class="tab" id="tabFavs">Избранное ⭐</div>
    </div>

    <div class="card" id="searchCard">
      <div class="row">
        <div class="searchbox">
          <input id="q" type="text" placeholder="пример: парацетамол + ибупрофен" />
          <div id="ac" class="ac"></div>
        </div>
        <button id="find">Найти</button>
      </div>
      <div class="row" style="margin-top:10px">
        <select id="form"><option value="">Форма выпуска</option></select>
        <select id="country"><option value="">Страна</option></select>
        <label class="pill"><input type="checkbox" id="znvlp" /> ЖНВЛП</label>
      </div>
    </div>

    <div class="grid" id="results"></div>
    <div class="empty" id="empty" style="display:none">Список пуст</div>
  </div>

<script>
  // Telegram MiniApp — безопасно
  try{Telegram.WebApp?.ready();Telegram.WebApp.setHeaderColor('#151924');Telegram.WebApp.setBackgroundColor('#0f1115')}catch(e){}

  // Анти-кэш
  let VERSION = Date.now().toString();
  async function getVersion(){
    try{ VERSION=(await fetch('data/version.txt',{cache:'no-store'}).then(r=>r.text())).trim()||VERSION }catch(e){}
  }
  const url = p => `${p}?v=${encodeURIComponent(VERSION)}`;

  // CSV parser
  function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    const headers = (lines.shift()||'').split(',').map(h=>h.trim());
    return lines.filter(Boolean).map(line=>{
      const cells=[]; let q=false; let c='';
      for(const ch of line){
        if(ch==='\"'){ q=!q; continue }
        if(ch===',' && !q){ cells.push(c); c=''; } else { c+=ch }
      }
      cells.push(c);
      const obj={}; headers.forEach((h,i)=>obj[h]=(cells[i]||'').trim());
      return obj;
    });
  }

  const S = { p:[], i:[], r:[], favs:new Set(), showFavs:false, synonyms:new Map(), allTerms:[] };

  const favLoad = () => new Set(JSON.parse(localStorage.getItem('favs')||'[]'));
  const favSave = (set) => localStorage.setItem('favs', JSON.stringify([...set]));

  async function load(){
    await getVersion();
    const [p,i,r,syn] = await Promise.all([
      fetch(url('data/products.csv'),{cache:'no-store'}).then(r=>r.text()),
      fetch(url('data/ingredients.csv'),{cache:'no-store'}).then(r=>r.text()),
      fetch(url('data/prices.csv'),{cache:'no-store'}).then(r=>r.text()),
      fetch(url('data/dictionaries/inn_synonyms.csv'),{cache:'no-store'}).then(r=> r.ok ? r.text() : 'alias,inn')
    ]);
    S.p = parseCSV(p);
    S.i = parseCSV(i).map(x=>({...x, inn:(x.inn||'').toLowerCase()}));
    S.r = parseCSV(r);
    S.favs = favLoad();

    // synonyms map: alias -> normalized inn string
    parseCSV(syn).forEach(row=>{
      const a=(row.alias||'').toLowerCase().trim();
      const v=(row.inn||'').toLowerCase().trim();
      if(a && v) S.synonyms.set(a,v);
    });

    // набор терминов для автокомплита (ИНН + алиасы)
    const innSet = new Set(S.i.map(x=>x.inn).filter(Boolean));
    S.allTerms = [...new Set([...innSet, ...S.synonyms.keys()])].sort();

    fillFilters();

    const urlQ = new URLSearchParams(location.search).get('q');
    if(urlQ) document.getElementById('q').value = urlQ;
    refresh();
  }

  function fillFilters(){
    const forms=[...new Set(S.p.map(x=>x.dosage_form).filter(Boolean))].sort();
    const countries=[...new Set(S.p.map(x=>x.country).filter(Boolean))].sort();
    const formSel=document.getElementById('form'); formSel.innerHTML='<option value="">Форма выпуска</option>';
    forms.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;formSel.appendChild(o)});
    const countrySel=document.getElementById('country'); countrySel.innerHTML='<option value="">Страна</option>';
    countries.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;countrySel.appendChild(o)});
  }

  // нормализация ввода: alias -> inn(s), дробим по + , , /
  function normalizeQueryToInns(s){
    s=(s||'').toLowerCase();
    // заменяем alias на канонические МНН (включая комбо alias, например «ибуклин»)
    // сначала точная замена, если весь запрос — один alias-комбо
    if(S.synonyms.has(s)) s = S.synonyms.get(s);

    // далее по токенам
    let raw = s.replace(/[,+/]/g,' ').split(/\s+/).filter(Boolean);
    raw = raw.map(tok => S.synonyms.get(tok) || tok); // одиночные алиасы
    // «разворачиваем» возможные подстановки-комбо (парацетамол + ибупрофен)
    const expanded=[];
    for(const t of raw){
      if(t.includes(' + ')) expanded.push(...t.split(' + ').map(x=>x.trim()));
      else expanded.push(t);
    }
    // убираем дубликаты и пустые
    return [...new Set(expanded.filter(Boolean))];
  }

  function search(){
    const q=document.getElementById('q').value.trim();
    const fs=document.getElementById('form').value;
    const cn=document.getElementById('country').value;
    const zn=document.getElementById('znvlp').checked;

    const inns = normalizeQueryToInns(q);

    const acc=new Map();
    for(const row of S.i){
      if(!inns.length || inns.includes(row.inn)){
        const set=acc.get(row.product_id)||new Set();
        set.add(row.inn); acc.set(row.product_id,set);
      }
    }
    const need=new Set(inns).size;
    let ids=[...acc.entries()].filter(([_,set])=>!inns.length||set.size===need).map(([id])=>id);

    let items=S.p.filter(p=>ids.includes(p.product_id));
    if(fs) items=items.filter(p=>p.dosage_form===fs);
    if(cn) items=items.filter(p=>p.country===cn);
    if(zn) items=items.filter(p=>String(p.is_znvlp).toLowerCase()==='true');
    if(S.showFavs) items=items.filter(p=>S.favs.has(p.product_id));

    render(items);
  }

  function toggleFav(id){
    if(S.favs.has(id)) S.favs.delete(id); else S.favs.add(id);
    favSave(S.favs);
    refresh();
  }

  function render(items){
    const root=document.getElementById('results');
    const empty=document.getElementById('empty');
    root.innerHTML='';
    empty.style.display=items.length?'none':'block';

    items.forEach(p=>{
      const ingr=S.i.filter(x=>x.product_id===p.product_id).map(x=>`${x.inn} ${x.strength||''}${x.unit||''}`.trim()).join(' + ');
      const price=S.r.find(x=>x.product_id===p.product_id);

      const div=document.createElement('div');
      div.className='drug';
      div.innerHTML = `
        <div class="name">${p.trade_name||'Без названия'}</div>
        <div class="meta">${ingr||'—'}<br/>${p.dosage_form||''} • ${p.pack||''}</div>
        <div class="tags">
          ${p.country? `<span class='pill'>${p.country}</span>`:''}
          ${String(p.is_znvlp).toLowerCase()==='true' ? `<span class='pill'>ЖНВЛП</span>`:''}
          ${p.atc_code? `<span class='pill'>ATC: ${p.atc_code}</span>`:''}
        </div>
        <div class="meta">${price? `Предельная цена: <b>${price.znvlp_price_rub} ₽</b> (на ${price.price_date})`:''}</div>
        <div class="meta">
          ${p.ru_registry_url? `<a href='${p.ru_registry_url}' target='_blank'>ГРЛС</a>`:''}
          ${p.instruction_url? ` • <a href='${p.instruction_url}' target='_blank'>Инструкция</a>`:''}
        </div>
      `;
      const fav=document.createElement('button');
      const active=S.favs.has(p.product_id);
      fav.className='fav'+(active?' active':'');
      fav.textContent=active?'★':'☆';
      fav.onclick=()=>toggleFav(p.product_id);
      div.appendChild(fav);
      root.appendChild(div);
    });
  }

  function showSearchTab(){
    document.getElementById('tabSearch').classList.add('active');
    document.getElementById('tabFavs').classList.remove('active');
    S.showFavs=false;
    document.getElementById('searchCard').style.display='block';
    search();
  }
  function showFavsTab(){
    document.getElementById('tabFavs').classList.add('active');
    document.getElementById('tabSearch').classList.remove('active');
    S.showFavs=true;
    document.getElementById('searchCard').style.display='none';
    render(S.p.filter(p=>S.favs.has(p.product_id)));
  }
  const refresh=()=> (S.showFavs? showFavsTab(): search());

  // ==== АВТОПОДСКАЗКИ ====
  const acEl = document.getElementById('ac');
  const qEl = document.getElementById('q');
  let acIndex = -1;

  function currentTokens(){
    const val = qEl.value;
    // берём всё до последнего разделителя и сам последний токен
    const parts = val.split(/[\s+]+/);
    const last = parts.pop() || '';
    const before = val.slice(0, val.length - last.length);
    return {before, last:last.toLowerCase()};
  }

  function showAC(){
    const {before,last} = currentTokens();
    if(!last){ acEl.style.display='none'; acIndex=-1; return; }
    const list = S.allTerms
      .filter(t=> t.startsWith(last))
      .slice(0,8);

    if(!list.length){ acEl.style.display='none'; acIndex=-1; return; }

    acEl.innerHTML = list.map((t,i)=>{
      const hl = `<b>${t.slice(0,last.length)}</b>${t.slice(last.length)}`;
      return `<div class="ac-item${i===0?' active':''}" data-val="${t}">${hl}</div>`;
    }).join('');
    acIndex = 0;
    acEl.style.display='block';

    // клики
    [...acEl.querySelectorAll('.ac-item')].forEach((el,idx)=>{
      el.onclick = ()=>applyAC(el.getAttribute('data-val'));
    });
  }

  function moveAC(dir){
    const items = [...acEl.querySelectorAll('.ac-item')];
    if(!items.length) return;
    acIndex = (acIndex + dir + items.length) % items.length;
    items.forEach((el,i)=> el.classList.toggle('active', i===acIndex));
  }

  function applyAC(val){
    const {before,last} = currentTokens();
    // заменяем последний токен на каноническое значение (учитываем alias-комбо)
    const normalized = S.synonyms.get(val) || val;
    const append = normalized.includes(' + ') ? normalized : normalized; // уже обработано
    const glue = (before && !before.trim().endsWith('+') && before.trim()) ? ' + ' : '';
    qEl.value = (before.trimEnd() + glue + append).trim();
    acEl.style.display='none'; acIndex=-1;
    search();
  }

  qEl.addEventListener('input', showAC);
  qEl.addEventListener('keydown', (e)=>{
    if(acEl.style.display==='block'){
      if(e.key==='ArrowDown'){ e.preventDefault(); moveAC(1); }
      else if(e.key==='ArrowUp'){ e.preventDefault(); moveAC(-1); }
      else if(e.key==='Enter'){ e.preventDefault(); const el=acEl.querySelector('.ac-item.active'); if(el) applyAC(el.getAttribute('data-val')); }
      else if(e.key==='Escape'){ acEl.style.display='none'; acIndex=-1; }
    }
    if(e.key==='Enter' && acEl.style.display!=='block'){ search(); }
  });
  document.addEventListener('click', (e)=>{ if(!document.querySelector('.searchbox').contains(e.target)) { acEl.style.display='none'; acIndex=-1; } });

  // события
  document.getElementById('tabSearch').onclick=showSearchTab;
  document.getElementById('tabFavs').onclick=showFavsTab;
  document.getElementById('find').onclick=search;
  document.getElementById('form').onchange=search;
  document.getElementById('country').onchange=search;
  document.getElementById('znvlp').onchange=search;

  load();
</script>
</body>
</html>
