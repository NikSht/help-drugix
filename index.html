<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Help.Drugix — комбо-поиск</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f1115;--card:#151924;--ink:#e6e8ef;--muted:#9aa3b2;--accent:#6aa0ff;--pill:#0d1320;--border:#2a3346}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    .brand{display:flex;align-items:center;gap:12px;margin:6px 0 18px}
    .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,#5aa0ff,#9b7bff)}
    h1{font-size:20px;margin:0}
    .tabs{display:flex;gap:8px;margin-bottom:10px}
    .tab{background:#0e121a;border:1px solid var(--border);color:var(--ink);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .tab.active{background:var(--accent);color:#0b1020;border-color:var(--accent)}
    .card{background:var(--card);border:1px solid #273047;border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input,select,button,label.pill{background:#0e121a;color:var(--ink);border:1px solid var(--border);border-radius:12px;padding:12px 14px;font-size:15px}
    input::placeholder{color:#71809a}
    button.find{background:var(--accent);border-color:var(--accent);color:#0b1020;font-weight:700;cursor:pointer;min-width:86px;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    .spinner{width:16px;height:16px;border:2px solid #0b1020;border-right-color:transparent;border-radius:50%;display:inline-block;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--pill);color:#b8c2d6;border-radius:999px;padding:6px 10px;font-size:12px;border:1px solid var(--border);cursor:pointer}
    .pill input{margin:0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:12px}
    .drug{background:#0e121a;border:1px solid var(--border);border-radius:14px;padding:12px;position:relative}
    .name{font-weight:700;padding-right:34px}
    .meta{color:var(--muted);font-size:13px;margin:6px 0}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    a{color:#9bbcff;text-decoration:none}
    .empty{color:#9aa3b2;opacity:.85;padding:24px;text-align:center}
    /* звезда */
    .fav{position:absolute;top:10px;right:10px;background:none;border:none;cursor:pointer;font-size:18px;line-height:1}
    .fav span{filter:drop-shadow(0 0 4px rgba(0,0,0,.4));transition:transform .15s ease}
    .fav:hover span{transform:scale(1.15)}
    .fav .star{color:#55607a}
    .fav.active .star{color:#ffcc33}
    /* модалка вариантов */
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-end;justify-content:center}
    .modal{width:min(820px,96vw);background:#0e121a;border:1px solid var(--border);border-radius:18px 18px 0 0;padding:16px 16px 10px;max-height:82vh;overflow:auto}
    .modal h3{margin:0 0 8px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #1c2333;padding:8px;text-align:left}
    th{position:sticky;top:0;background:#101827}
    .modal-actions{display:flex;justify-content:flex-end;padding:10px 0 4px}
    .close{background:#182033;border:1px solid #26304a;color:#d7d9e3;border-radius:10px;padding:8px 12px;cursor:pointer}
    /* мини-лоадер списка */
    .list-loader{display:none;gap:8px;align-items:center;justify-content:center;color:#9aa3b2;margin:8px 0}
    .list-loader .spinner{border-color:#9aa3b2;border-right-color:transparent}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand"><div class="logo"></div><h1>Help.Drugix — поиск комбинированных препаратов (РФ)</h1></div>

    <div class="tabs">
      <button id="tabSearch" class="tab active">Поиск</button>
      <button id="tabFavs" class="tab">Избранное ⭐</button>
    </div>

    <div class="card" id="searchCard">
      <div class="row">
        <input id="q" type="text" placeholder="пример: парацетамол + ибупрофен • или введите торговое название" style="flex:1;min-width:220px"/>
        <button id="find" class="find"><span>Найти</span></button>
      </div>
      <div class="row" style="margin-top:10px;align-items:center">
        <select id="form" style="min-width:220px"><option value="">Форма выпуска</option></select>
        <select id="country" style="min-width:200px"><option value="">Страна</option></select>
        <label class="pill" title="Показывать только монопрепараты по заданному веществу (по умолчанию)">
          <input type="checkbox" id="mono" checked/> Только это вещество
        </label>
        <label class="pill"><input type="checkbox" id="znvlp"/> ЖНВЛП</label>
      </div>
    </div>

    <div class="list-loader" id="listLoader"><span class="spinner"></span><span>Идёт поиск…</span></div>
    <div class="grid" id="results"></div>
    <div class="empty" id="empty" style="display:none">Ничего не найдено. Измените запрос или фильтры.</div>
  </div>

  <!-- Модальное окно «Варианты» -->
  <div class="modal-back" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalTitle">Варианты</h3>
      <div class="meta" id="modalSub"></div>
      <table>
        <thead><tr><th>Форма</th><th>Дозировка</th><th>Упаковка</th></tr></thead>
        <tbody id="modalBody"></tbody>
      </table>
      <div class="modal-actions"><button class="close" id="modalClose">Закрыть</button></div>
    </div>
  </div>

  <script>
  // --- Telegram Mini App init (works also in a regular browser) ---
  try{if(window.Telegram&&Telegram.WebApp){Telegram.WebApp.ready();Telegram.WebApp.setHeaderColor('#151924');Telegram.WebApp.setBackgroundColor('#0f1115');}}catch(e){}

  // -------------------- DATA --------------------
  const DATA={
    products:'data/products.csv',
    ingredients:'data/ingredients.csv',
    dict_inn:'dictionaries/inn_synonyms.csv',
    dict_brand:'dictionaries/brand_synonyms.csv',
    dict_form:'dictionaries/form_normalization.csv',
    dict_country:'dictionaries/country_normalization.csv',
  };

  // CSV parser (quotes-safe)
  function parseCSV(text){
    const lines=text.replace(/\r/g,'').trim().split('\n');
    if(!lines.length) return [];
    const headers=lines[0].split(',').map(h=>h.trim());
    const out=[];
    for(let i=1;i<lines.length;i++){
      const row=lines[i]; if(row==='') continue;
      const cells=[]; let cur='',q=false;
      for(let j=0;j<row.length;j++){
        const ch=row[j];
        if(ch==='\"'){ q=!q; continue }
        if(ch===','&&!q){ cells.push(cur); cur=''; } else { cur+=ch }
      }
      cells.push(cur);
      const obj={};
      headers.forEach((h,idx)=>obj[h]= (cells[idx]??'').trim());
      out.push(obj);
    }
    return out;
  }

  const state={ products:[], ingredients:[], byBrand:new Map(), dicts:{inn:new Map(), brand:new Map(), form:new Map(), country:new Map()} };

  // helpers
  const norm=(s)=> String(s||'').toLowerCase().trim();
  const stripHyphens=(s)=>norm(s).replace(/-/g,'');
  function splitQuery(q){
    // +, запятая, пробелы
    return norm(q).split(/[,+]/g).map(x=>x.trim()).flatMap(x=>x.split(/\s+/g)).map(x=>x.trim()).filter(Boolean);
  }

  async function safeFetch(url){
    try{ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw 0; return await r.text(); }
    catch(e){ return '' }
  }

  async function load(){
    // параллельно тянем всё
    const [p,i,d1,d2,d3,d4]=await Promise.all([
      safeFetch(DATA.products), safeFetch(DATA.ingredients),
      safeFetch(DATA.dict_inn), safeFetch(DATA.dict_brand),
      safeFetch(DATA.dict_form), safeFetch(DATA.dict_country),
    ]);
    state.products=parseCSV(p);
    state.ingredients=parseCSV(i);

    // словари (если есть)
    for(const [raw,map] of [[d1,'inn'],[d2,'brand'],[d3,'form'],[d4,'country']]){
      if(raw){
        const arr=parseCSV(raw);
        for(const row of arr){
          // ожидаем формат: alias,src  (или src,alias — не критично: возьмем оба)
          const a=(row.alias||row.src||row[Object.keys(row)[0]]||'').toLowerCase().trim();
          const b=(row.src||row.canon||row[Object.keys(row)[1]]||'').toLowerCase().trim();
          if(a && b){ state.dicts[map].set(a,b); }
        }
      }
    }

    // карта brand -> массив продуктов
    state.byBrand.clear();
    for(const p of state.products){
      const bn = p.trade_name || p.brand || '';
      const key = norm(bn);
      if(!state.byBrand.has(key)) state.byBrand.set(key,[]);
      state.byBrand.get(key).push(p);
    }

    // Авторан с ?q=
    const urlQ=new URLSearchParams(location.search).get('q');
    if(urlQ){ document.getElementById('q').value=urlQ; doSearch(); }
  }

  // нормализация формы/страны (для фильтров)
  function normalizeForm(v){ const s=norm(v); return state.dicts.form.get(s) || v || ''; }
  function normalizeCountry(v){ const s=norm(v); return state.dicts.country.get(s) || v || ''; }

  // собрать INNs продукта
  function ingredientsForProduct(id){
    return state.ingredients.filter(r=>r.product_id===id);
  }
  // строка дозировки (коротко)
  function doseLineForProduct(id){
    const rows=ingredientsForProduct(id);
    return rows.map(r=>{
      const inn=(r.normalized_mnn||r.inn||'').toLowerCase();
      const dose=[r.strength||'',r.unit||''].join('').trim();
      return [inn,dose].filter(Boolean).join(' ');
    }).join(' + ');
  }

  // --- Поисковые режимы
  function buildSearchTokens(q){
    const tokens=splitQuery(q);
    // подмешаем версии без дефисов
    const plus=[];
    for(const t of tokens){ const z=stripHyphens(t); if(z!==t) plus.push(z); }
    return Array.from(new Set(tokens.concat(plus)));
  }

  function aliasResolveInn(word){
    const s=norm(word);
    if(state.dicts.inn.size){
      if(state.dicts.inn.has(s)) return state.dicts.inn.get(s);
    }
    return s;
  }
  function aliasResolveBrand(word){
    const s=norm(word);
    if(state.dicts.brand.size){
      if(state.dicts.brand.has(s)) return state.dicts.brand.get(s);
    }
    return s;
  }

  // фильтры заполнить по найденным товарам
  function hydrateFiltersFrom(items){
    const formSel=document.getElementById('form');
    const countrySel=document.getElementById('country');
    const forms=new Set(), countries=new Set();
    for(const it of items){
      const f=normalizeForm(it.dosage_form);
      if(f) forms.add(f);
      const c=normalizeCountry(it.country);
      if(c) countries.add(c);
    }
    const curF=formSel.value, curC=countrySel.value;
    formSel.innerHTML='<option value="">Форма выпуска</option>';
    Array.from(forms).sort((a,b)=>a.localeCompare(b)).forEach(v=>{
      const o=document.createElement('option'); o.value=v; o.textContent=v; formSel.appendChild(o);
    });
    countrySel.innerHTML='<option value="">Страна</option>';
    Array.from(countries).sort((a,b)=>a.localeCompare(b)).forEach(v=>{
      const o=document.createElement('option'); o.value=v; o.textContent=v; countrySel.appendChild(o);
    });
    // попытаться сохранить выбранные значения (если ещё актуальны)
    if(curF && Array.from(forms).includes(curF)) formSel.value=curF;
    if(curC && Array.from(countries).includes(curC)) countrySel.value=curC;
  }

  // группировка по бренду (торг. названию)
  function groupByBrand(items){
    const map=new Map();
    for(const p of items){
      const key=norm(p.trade_name||p.brand||p.trade||'');
      if(!map.has(key)) map.set(key,[]);
      map.get(key).push(p);
    }
    return Array.from(map.entries()).map(([brand,rows])=>({brand,rows}));
  }

  // сортировка вариантов по дозе, адаптивно под запрос
  function dosageSortKey(product, focusInns){
    // берём дозы только по тем INN, что в поиске (или все, если их нет)
    const rows=ingredientsForProduct(product.product_id);
    const pick = focusInns && focusInns.length ? rows.filter(r=> focusInns.includes(norm(r.normalized_mnn||r.inn||''))) : rows;
    // возьмём первую числовую дозу
    let best=0;
    for(const r of pick){
      const s=String(r.strength||'').replace(',', '.');
      const v=parseFloat(s);
      if(!isNaN(v)){ best=Math.max(best, v); }
    }
    return best || 0;
  }

  // Избранное (по бренду)
  const favKey='favs_brands_v1';
  function getFavSet(){ try{ return new Set(JSON.parse(localStorage.getItem(favKey)||'[]'));}catch(e){return new Set()} }
  function saveFavSet(set){ localStorage.setItem(favKey, JSON.stringify(Array.from(set))); }
  function isFavBrand(brand){ return getFavSet().has(norm(brand||'')); }
  function toggleFavBrand(brand){
    const s=getFavSet(); const k=norm(brand||'');
    if(s.has(k)) s.delete(k); else s.add(k);
    saveFavSet(s);
  }

  // Рендер
  let lastResults=[]; // плоский список products после поиска (до группировки)
  function render(items, {focusInns=[]}={}){
    const root=document.getElementById('results');
    const empty=document.getElementById('empty');
    root.innerHTML='';
    if(!items.length){ empty.style.display='block'; return; }
    empty.style.display='none';

    // группируем по бренду
    const groups=groupByBrand(items);

    for(const g of groups){
      const brandTitle=g.rows[0]?.trade_name || g.rows[0]?.brand || 'Без названия';
      // варианты — уникальные по (форма+доза+упаковка)
      const seen=new Set();
      const variants=[];
      for(const p of g.rows){
        const form=normalizeForm(p.dosage_form||'');
        const pack=p.pack||'';
        const dose=doseLineForProduct(p.product_id);
        const key=[form,dose,pack].join('•');
        if(seen.has(key)) continue;
        seen.add(key);
        variants.push({product:p, form, pack, dose, sort:dosageSortKey(p, focusInns)});
      }
      variants.sort((a,b)=> a.sort-b.sort || a.form.localeCompare(b.form));

      const manuf = g.rows.find(x=>x.manufacturer)||''; // берём первый непустой
      const country = normalizeCountry(g.rows.find(x=>x.country)||'');

      const div=document.createElement('div');
      div.className='drug';
      const favActive = isFavBrand(brandTitle);
      div.innerHTML=`
        <button class="fav ${favActive?'active':''}" data-brand="${brandTitle}" title="В избранное">
          <span class="star">★</span>
        </button>
        <div class="name">${brandTitle}</div>
        <div class="meta">${variants[0]?.dose || ''}<br/>${variants[0]?.form || ''} • ${variants[0]?.pack || ''}</div>
        <div class="tags">
          ${country?`<span class="pill">${country}</span>`:''}
          ${(g.rows.some(x=>String(x.is_znvlp).toLowerCase()==='true'))?`<span class="pill">ЖНВЛП</span>`:''}
          ${g.rows[0]?.atc_code?`<span class="pill">ATC: ${g.rows[0].atc_code}</span>`:''}
          <span class="pill" data-variants="${encodeURIComponent(JSON.stringify(variants.map(v=>({f:v.form,d:v.dose,p:v.pack}))))}" data-brand="${brandTitle}">Варианты</span>
        </div>
        <div class="meta">
          ${(g.rows[0]?.ru_registry_url?`<a href="${g.rows[0].ru_registry_url}" target="_blank">ГРЛС</a>`:'')}
          ${(g.rows[0]?.instruction_url?` • <a href="${g.rows[0].instruction_url}" target="_blank">Инструкция</a>`:'')}
        </div>
        <div class="meta">${(manuf || country)?`Производитель: ${[manuf,country].filter(Boolean).join(', ')}`:''}</div>
      `;
      root.appendChild(div);
    }

    // обработчики избранного и вариантов
    root.querySelectorAll('.fav').forEach(btn=>{
      btn.onclick=()=>{
        const brand=btn.getAttribute('data-brand');
        toggleFavBrand(brand);
        btn.classList.toggle('active', isFavBrand(brand));
      };
    });
    root.querySelectorAll('.tags .pill').forEach(p=>{
      if(p.textContent==='Варианты'){
        p.style.cursor='pointer';
        p.onclick=()=>{
          const brand=p.getAttribute('data-brand');
          const data=JSON.parse(decodeURIComponent(p.getAttribute('data-variants')));
          openVariantsModal(brand, data);
        };
      }
    });
  }

  // Модалка «варианты»
  function openVariantsModal(brand, rows){
    document.getElementById('modalTitle').textContent=brand;
    document.getElementById('modalSub').textContent=`Найдено вариантов: ${rows.length}`;
    const body=document.getElementById('modalBody');
    body.innerHTML='';
    for(const r of rows){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.f||''}</td><td>${r.d||''}</td><td>${r.p||''}</td>`;
      body.appendChild(tr);
    }
    document.getElementById('modalBack').style.display='flex';
  }
  document.getElementById('modalClose').onclick=()=>{document.getElementById('modalBack').style.display='none'};
  document.getElementById('modalBack').onclick=(e)=>{ if(e.target.id==='modalBack') e.currentTarget.style.display='none' };

  // --- Поиск ---
  function showLoader(on){
    document.getElementById('listLoader').style.display= on?'flex':'none';
    const btn=document.getElementById('find');
    if(on){
      btn.disabled=true;
      btn.innerHTML='<span class="spinner"></span><span>Поиск…</span>';
    }else{
      btn.disabled=false;
      btn.innerHTML='<span>Найти</span>';
    }
  }

  function doSearch(mode='search'){
    showLoader(true);
    setTimeout(()=>{ // малюсенькая задержка, чтобы показать лоадер
      const q=document.getElementById('q').value||'';
      const formsel=document.getElementById('form').value||'';
      const countrysel=document.getElementById('country').value||'';
      const needZnvlp=document.getElementById('znvlp').checked;
      const onlyMono=document.getElementById('mono').checked;

      let tokens=buildSearchTokens(q); // строковые кусочки
      const innTokens=tokens.map(aliasResolveInn);
      const brandTokens=tokens.map(aliasResolveBrand);

      // собираем кандидатов
      let items=[...state.products];

      // фильтр по бренду ИЛИ по INN
      if(tokens.length){
        // бранды
        const brandSet=new Set(brandTokens);
        const hyphenless=new Set(tokens.map(stripHyphens));
        items=items.filter(p=>{
          const b=norm(p.trade_name||p.brand||'');
          const b2=stripHyphens(b);
          const byBrand = brandSet.has(b) || hyphenless.has(b2);
          // INN
          const ings=ingredientsForProduct(p.product_id).map(r=> norm(r.normalized_mnn||r.inn||''));
          const set=new Set(ings);
          const byInns = innTokens.every(t=> set.has(t));
          return byBrand || byInns;
        });
      }

      // режим «только это вещество» — пропускаем только монопрепараты по одному INN
      if(onlyMono && tokens.length>=1){
        const focus = aliasResolveInn(tokens[0]);
        items=items.filter(p=>{
          const ings=ingredientsForProduct(p.product_id).map(r=> norm(r.normalized_mnn||r.inn||''));
          const uniq=new Set(ings);
          return uniq.size===1 && uniq.has(focus);
        });
      }

      // обычные фильтры
      if(formsel) items=items.filter(p=> normalizeForm(p.dosage_form)===formsel);
      if(countrysel) items=items.filter(p=> normalizeCountry(p.country)===countrysel);
      if(needZnvlp) items=items.filter(p=> String(p.is_znvlp).toLowerCase()==='true');

      lastResults=items.slice();
      // обновить списки фильтров по найденным
      hydrateFiltersFrom(items);

      // показать
      const focusInns = (onlyMono && tokens.length)? [aliasResolveInn(tokens[0])] : [];
      render(items,{focusInns});
      showLoader(false);
    }, 50);
  }

  // --- Вкладки ---
  function showSearch(){ document.getElementById('tabSearch').classList.add('active'); document.getElementById('tabFavs').classList.remove('active'); doSearch(); }
  function showFavs(){
    document.getElementById('tabFavs').classList.add('active'); document.getElementById('tabSearch').classList.remove('active');
    // собрать все продукты, бренды которых в избранном
    const favs=getFavSet();
    const items=state.products.filter(p=> favs.has(norm(p.trade_name||p.brand||'')));
    hydrateFiltersFrom(items);
    render(items);
  }

  // события
  document.getElementById('tabSearch').onclick=showSearch;
  document.getElementById('tabFavs').onclick=showFavs;

  document.getElementById('find').onclick=doSearch;
  document.getElementById('q').addEventListener('keydown',e=>{ if(e.key==='Enter') doSearch(); });
  document.getElementById('form').addEventListener('change', ()=>doSearch());
  document.getElementById('country').addEventListener('change', ()=>doSearch());
  document.getElementById('znvlp').addEventListener('change', ()=>doSearch());
  document.getElementById('mono').addEventListener('change', ()=>doSearch());

  load();
  </script>
</body>
</html>
