<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Help.Drugix — комбо-поиск</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0f1115; --card:#151924; --ink:#e6e8ef; --muted:#9aa3b2; --accent:#6aa0ff; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:20px}
    .brand{display:flex;align-items:center;gap:12px;margin:6px 0 18px}
    .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,#5aa0ff,#9b7bff)}
    h1{font-size:20px;margin:0}
    .card{background:var(--card);border:1px solid #273047;border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input,select,button{background:#0e121a;color:var(--ink);border:1px solid #2a3346;border-radius:12px;padding:12px 14px;font-size:15px}
    input::placeholder{color:#71809a}
    button{background:var(--accent);border-color:var(--accent);color:#0b1020;font-weight:700;cursor:pointer}
    .pill{background:#0d1320;border:1px solid #2a3346;color:#b8c2d6;border-radius:999px;padding:6px 10px;font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:12px}
    .drug{background:#0e121a;border:1px solid #2a3346;border-radius:14px;padding:12px;position:relative}
    .name{font-weight:700;padding-right:36px}
    .meta{color:var(--muted);font-size:13px;margin:6px 0}
    .empty{color:#9aa3b2;opacity:.8;padding:24px;text-align:center}
    a{color:#9bbcff;text-decoration:none}
    .fav{position:absolute;right:10px;top:10px;background:none;border:none;font-size:18px;line-height:1;cursor:pointer;transform-origin:center;transition:.15s;filter:grayscale(1);color:#556}
    .fav.active{filter:none;color:#f5c84b}
    .fav:hover{transform:scale(1.1)}
    .tabs{display:flex;gap:10px;margin-bottom:10px}
    .tab{background:#0e121a;border:1px solid #2a3346;border-radius:10px;padding:8px 12px;cursor:pointer}
    .tab.active{background:#1a2233;border-color:#3a4a6b}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand"><div class="logo"></div><h1>Help.Drugix — поиск комбинированных препаратов (РФ)</h1></div>

    <div class="tabs">
      <div class="tab active" id="tabSearch">Поиск</div>
      <div class="tab" id="tabFavs">Избранное ⭐</div>
    </div>

    <div class="card" id="searchCard">
      <div class="row">
        <input id="q" type="text" placeholder="пример: парацетамол + ибупрофен • или введите торговое название" style="flex:1;min-width:220px" />
        <button id="find">Найти</button>
      </div>
      <div class="row" style="margin-top:10px">
        <select id="form"><option value="">Форма выпуска</option></select>
        <select id="country"><option value="">Страна</option></select>
        <label class="pill"><input type="checkbox" id="znvlp" /> жнвлп</label>
      </div>
    </div>

    <div class="grid" id="results"></div>
    <div class="empty" id="empty" style="display:none">Ничего не найдено. Измените запрос или фильтры.</div>
  </div>

<script>
/* Telegram theme (не мешает работе в браузере) */
try{ if (window.Telegram && Telegram.WebApp){ Telegram.WebApp.ready(); Telegram.WebApp.setHeaderColor('#151924'); Telegram.WebApp.setBackgroundColor('#0f1115'); } }catch(e){}

/* Источники данных */
const DATA = {
  products: 'data/products.csv',
  ingredients: 'data/ingredients.csv',
  prices: 'data/prices.csv'
};

/* ===== CSV парсер с авто-определением разделителя и кавычек ===== */
function parseCSV(text){
  const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n').filter(Boolean);
  if(!lines.length) return [];
  const first = lines[0];
  const comma = (first.match(/,/g)||[]).length, semi = (first.match(/;/g)||[]).length;
  const delim = semi > comma ? ';' : ',';

  function splitSafe(line){
    const out=[], q='"'; let cur='', inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch===q){ inQ=!inQ; continue; }
      if(ch===delim && !inQ){ out.push(cur); cur=''; }
      else cur+=ch;
    }
    out.push(cur);
    return out;
  }

  const headers = splitSafe(lines[0]).map(h=>h.trim());
  return lines.slice(1).map(row=>{
    const cells = splitSafe(row).map(c=>c.trim());
    const obj={};
    headers.forEach((h,i)=> obj[h]= (cells[i]??'').trim());
    return obj;
  });
}

/* ===== Приведение колонок к универсальному виду ===== */
function normBool(v){
  const s = String(v||'').trim().toLowerCase();
  return ['1','true','да','yes','y'].includes(s);
}
function firstNonEmpty(...xs){ for(const x of xs){ if(x!==undefined && x!==null && String(x).trim()!=='') return x; } return ''; }

function normalizeProductsRow(r){
  // возможные имена колонок из разных источников
  const id = firstNonEmpty(
    r.product_id, r.klp_code, r['Код КЛП'], r.klp, r.code
  );
  const tn = firstNonEmpty(
    r.trade_name, r['Торговое наименование'], r.tn, r.tn_ru
  );
  const form = firstNonEmpty(
    r.dosage_form, r['Нормализованная лекарственная форма'], r.normalized_dosage_form, r.form
  );
  const pack = firstNonEmpty(
    r.pack, r['Нормализованная дозировка'], r.normalized_dosage, r.dosage
  );
  const country = firstNonEmpty(
    r.country, r['Страна'], r.country_of_origin, r.origin_country
  );
  const atc = firstNonEmpty(
    r.atc_code, r['Код АТХ'], r.atc
  );
  const znvlp = normBool(firstNonEmpty(
    r.is_znvlp, r['ЖНВЛП'], r.znvlp
  ));
  const grls = firstNonEmpty(r.ru_registry_url, r.grls_url, r['ГРЛС']);
  const instr = firstNonEmpty(r.instruction_url, r['Инструкция']);

  return {
    product_id: id, trade_name: tn, dosage_form: form, pack,
    country, is_znvlp: znvlp, atc_code: atc,
    ru_registry_url: grls, instruction_url: instr
  };
}

function normalizeIngrRow(r){
  const pid = firstNonEmpty(r.product_id, r.klp_code, r['Код КЛП'], r.klp, r.code);
  // МНН может храниться в normalized_mnn / inn / МНН
  let inn = firstNonEmpty(r.inn, r.normalized_mnn, r['Нормализованное МНН'], r.mnn);
  // Если вдруг пришёл список одним полем — разнесём позже в поиске; тут храним как есть
  return {
    product_id: pid,
    inn: (inn||'').toLowerCase().trim(),
    strength: firstNonEmpty(r.strength, r['Дозировка'], r.normalized_dosage,''),
    unit: firstNonEmpty(r.unit,'')
  };
}

const state = { products:[], ingredients:[], prices:[], favs:new Set(), synonyms:new Map(), terms:[] };

function loadFavs(){
  try{ state.favs = new Set(JSON.parse(localStorage.getItem('favs')||'[]')); }catch(_){ state.favs=new Set(); }
}
function saveFavs(){
  localStorage.setItem('favs', JSON.stringify(Array.from(state.favs)));
}

/* ===== Загрузка ===== */
async function load(){
  loadFavs();
  const [pTxt, iTxt, rTxt] = await Promise.all([
    fetch(DATA.products,{cache:'no-store'}).then(r=>r.text()),
    fetch(DATA.ingredients,{cache:'no-store'}).then(r=>r.text()),
    fetch(DATA.prices,{cache:'no-store'}).then(r=>r.text())
  ]);

  const pRaw = parseCSV(pTxt);
  const iRaw = parseCSV(iTxt);
  const rRaw = parseCSV(rTxt);

  state.products = pRaw.map(normalizeProductsRow).filter(x=>x.product_id);
  state.ingredients = iRaw.map(normalizeIngrRow).filter(x=>x.product_id && x.inn);
  state.prices = rRaw; // структура цен у нас и раньше подходила

  hydrateFilters();
  // Авто-запуск по ?q=
  const urlQ = new URLSearchParams(location.search).get('q');
  if(urlQ){ q.value=urlQ; doSearch(); }
}

function uniqSorted(arr){ return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=> a.localeCompare(b)); }

function hydrateFilters(){
  const forms = uniqSorted(state.products.map(p=>p.dosage_form));
  const countries = uniqSorted(state.products.map(p=>p.country));
  const formSel = document.getElementById('form');
  const countrySel = document.getElementById('country');
  forms.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; formSel.appendChild(o); });
  countries.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; countrySel.appendChild(o); });
}

/* ===== Поиск ===== */
function normalizeInnList(s){
  // поддержим разные разделители: +, ;, запятая
  return s.split(/[\+\;,]/).map(x=>x.trim().toLowerCase()).filter(Boolean);
}

function doSearch(){
  const qVal = document.getElementById('q').value.trim();
  const forms = document.getElementById('form').value;
  const country = document.getElementById('country').value;
  const needZnvlp = document.getElementById('znvlp').checked;

  const inns = normalizeInnList(qVal);
  let productIds;

  if(inns.length){
    // карта product_id -> множество совпавших МНН
    const acc = new Map();
    // ingredient.inn может содержать состав «парацетамол + ибупрофен» целиком, учитываем обе модели:
    for(const row of state.ingredients){
      const tokens = row.inn.split(/\s*\+\s*/).map(s=>s.trim()).filter(Boolean);
      for(const token of tokens){
        if(inns.includes(token)){
          const set = acc.get(row.product_id) || new Set();
          set.add(token);
          acc.set(row.product_id,set);
        }
      }
    }
    productIds = Array.from(acc.entries())
      .filter(([_,set]) => set.size === new Set(inns).size) // все МНН из запроса присутствуют
      .map(([pid])=>pid);
  }else{
    // Поиск по торговому названию (части)
    const needle = qVal.toLowerCase();
    productIds = state.products
      .filter(p => needle ? (p.trade_name||'').toLowerCase().includes(needle) : true)
      .map(p=>p.product_id);
  }

  let items = state.products.filter(p=> productIds.includes(p.product_id));
  if(forms) items = items.filter(p=>p.dosage_form===forms);
  if(country) items = items.filter(p=>p.country===country);
  if(needZnvlp) items = items.filter(p=> p.is_znvlp===true);

  render(items);
}

/* ===== Рендер ===== */
function favBtn(pid){
  const b = document.createElement('button');
  b.className = 'fav' + (state.favs.has(pid)?' active':'');
  b.textContent = '★';
  b.title = state.favs.has(pid)?'Убрать из избранного':'В избранное';
  b.onclick = ()=>{
    if(state.favs.has(pid)) state.favs.delete(pid); else state.favs.add(pid);
    saveFavs(); b.classList.toggle('active'); b.title = state.favs.has(pid)?'Убрать из избранного':'В избранное';
  };
  return b;
}

function render(items){
  const root = document.getElementById('results');
  root.innerHTML='';
  document.getElementById('empty').style.display = items.length? 'none':'block';
  items.forEach(p=>{
    const ingr = state.ingredients
      .filter(i=>i.product_id===p.product_id)
      .map(i=>i.inn).join(' + ');
    const price = state.prices.find(x=>x.product_id===p.product_id);
    const div = document.createElement('div');
    div.className='drug';
    div.appendChild(favBtn(p.product_id));
    div.innerHTML += `
      <div class="name">${p.trade_name || 'Без названия'}</div>
      <div class="meta">${ingr || '—'}<br/>${p.dosage_form || ''} • ${p.pack || ''}</div>
      <div class="meta">
        ${p.country? `<span class='pill'>${p.country}</span>`:''}
        ${p.is_znvlp? `<span class='pill'>ЖНВЛП</span>`:''}
        ${p.atc_code? `<span class='pill'>ATC: ${p.atc_code}</span>`:''}
      </div>
      <div class="meta">${price? `Предельная цена: <b>${price.znvlp_price_rub} ₽</b> (на ${price.price_date})`:' '}</div>
      <div class="meta">
        ${p.ru_registry_url? `<a href='${p.ru_registry_url}' target='_blank'>ГРЛС</a>`:''}
        ${p.instruction_url? ` • <a href='${p.instruction_url}' target='_blank'>Инструкция</a>`:''}
      </div>
    `;
    root.appendChild(div);
  });
}

/* ===== Вкладки (Поиск / Избранное) ===== */
function showSearch(){
  document.getElementById('tabSearch').classList.add('active');
  document.getElementById('tabFavs').classList.remove('active');
  document.getElementById('searchCard').style.display='block';
  document.getElementById('empty').style.display='none';
  document.getElementById('results').innerHTML='';
}
function showFavs(){
  document.getElementById('tabFavs').classList.add('active');
  document.getElementById('tabSearch').classList.remove('active');
  const ids = Array.from(state.favs);
  const items = state.products.filter(p=>ids.includes(p.product_id));
  render(items);
}

/* События */
document.getElementById('tabSearch').onclick = showSearch;
document.getElementById('tabFavs').onclick = showFavs;
document.getElementById('find').onclick = doSearch;
document.getElementById('q').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
document.getElementById('form').onchange = doSearch;
document.getElementById('country').onchange = doSearch;
document.getElementById('znvlp').onchange = doSearch;

load();
</script>
</body>
</html>
